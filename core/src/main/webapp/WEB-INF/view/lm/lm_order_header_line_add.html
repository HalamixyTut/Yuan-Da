<#include "../include/header.html">
<script src="${base.contextPath}/common/code?addressData=HCUX_LM.ORDER_ADDRESS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?itemUnit=HCUX_LM_ORDER_UNIT" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?itemSettlementWay=	HCUX_LM_ORDER_SETTLEMENT_WAY" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?orderStatus=	HCUX_LM_ORDER_STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?transportStatusData=HCUX_LM_TRANSPORT_STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?dangerGoodsUnData=HCUX_DANGEROUS_GOODS_UN_NO" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?dangerGoodsCatData=HCUX_DANGEROUS_GOODS_GENRES" type="text/javascript"></script>
<script type="text/javascript">
    var orderId = '${RequestParameters.orderId!}';
    var operationType = '${RequestParameters.type!}';
    var  currentTable="headerTab";
    var defaultDrawGoodsDate = new Date();
    var defaultArrivedDate = new Date();
    defaultArrivedDate.setDate(defaultArrivedDate.getDate() + 1);
    defaultArrivedDate.setHours(8);
    defaultArrivedDate.setMinutes(0);
    defaultArrivedDate.setSeconds(0);

    var viewModel = Hap.createGridViewModel("#grid", {
        model: {
            drawGoodsDate: defaultDrawGoodsDate,
            arrivedDate: defaultArrivedDate,
            consignorName: '远大能源化工有限公司'
        },
        saveFunction: function () {
            var validator = $("#edit-form").data("kendoValidator");

            // 校验
            if (!validator.validate()) {
                Hap.showToast({
                    type: 'error',
                    message: '保存失败，必填项未填！'
                });
                return;
            }

            if (viewModel.model.orderId) {
                viewModel.model.__status = 'update';
            } else {
                viewModel.model.orderId = null;
                viewModel.model.__status = 'add';
            }

            Hap.submitForm({
                url: '${base.contextPath}/hcux/lm/order/header/submit',
                formModel: viewModel.model,
                grid: {"lineList": $("#grid")},
                success: function (data) {
                    operationType = 'COPY_TO_EDIT';
                    $('#contractCodeOneInput').data("kendoLov").enable(false);
                    $('#contractCodeTwoInput').data("kendoLov").enable(false);
                    $('#contractCodeThreeInput').data("kendoLov").enable(false);
                    $('#grid').data('kendoGrid').dataSource.read();
                }
            });

        },
        backFunction: function () {
            window.parent.$("#addOrder").data("kendoWindow").close();
        }
    });

   function submitData() {
       var validator = $("#edit-form").data("kendoValidator");

       // 校验
       if (!validator.validate()) {
           Hap.showToast({
               type: 'error',
               message: '提交失败，必填项未填！'
           });
           return;
       }

       Hap.blockUI();
       $.ajax({
           type: 'POST',
           url: '${base.contextPath}/hcux/lm/order/header/submitToZh',
           datatype: "json",
           contentType: "application/json",
           data: JSON.stringify(viewModel.model),
           complete: function () {
               Hap.unblockUI();
           },
           success: function (data) {
               if (data.success) {
                   Hap.showToast({
                       type: 'success',
                       message: '提交成功'
                   });
                   viewModel.model.set("status", "1");
                   viewModel.model.set("rejectReason", "");
                   disabledAll();
               } else {
                   kendo.ui.showErrorDialog({
                       message: data.message || '提交失败'
                   });
               }
               $('#grid').data('kendoGrid').dataSource.read();
           }
       });
   }

   function syncTransFrom66() {
       if (viewModel.model.zhOrderId) {
           $.ajax({
               type: 'POST',
               url: '${base.contextPath}/hcux/lm/order/header/queryFromZh',
               datatype: "json",
               contentType: "application/json",
               async: false,
               data: JSON.stringify({entrustId: viewModel.model.zhOrderId}),
               success: function (data) {
                   if (data.success) {
                       Hap.showToast({
                           type: 'success',
                           message: '同步成功'
                       });
                       $('#gridTransport').data('kendoGrid').dataSource.page(1);
                   } else {
                       kendo.ui.showErrorDialog({
                           message: data.message || '同步失败'
                       });
                   }
               }
           });
       }
   }

    window.onload=function () {
        if (operationType === 'ADD' || operationType === 'COPY') {
            viewModel.model.set('status', '0');
        }
        if (viewModel.model.status != 1) {
            $('#toolbar-btn-trans').hide();
        }
    }

    $.ajax({
        type: 'POST',
        url: '${base.contextPath}/hr/employee/query',
        datatype: "json",
        async: false,
        data: {employeeCode: '${Session.employeeCode!"0"}'},
        success: function (data) {
            if (data.success && data.rows.length > 0) {
                viewModel.model.set('drawGoodsPeople', data.rows[0].name)
            }
        }
    });
    $.ajax({
        type: 'POST',
        url: '${base.contextPath}/sys/user/query',
        datatype: "json",
        async: false,
        data: {userId: '${Session.userId!}'},
        success: function (data) {
            if (data.success) {
                viewModel.model.set('drawGoodsMobile', data.rows[0].phone)
            }
        }
    });
</script>
<body>
<div id="page-content">

    <form class="form-horizontal" id="edit-form" style="">
        <div class="panel"  id="headerInfo">
            <div class="panel-body">
                <div class="row">
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="contractCodeOneInput">合同号1</label>
                            <div class="col-xs-8">
                                <input required data-bind="value:model.contractCodeOne,text:model.contractCodeOne"
                                       id="contractCodeOneInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="contractCodeTwoInput">合同号2</label>
                            <div class="col-xs-8">
                                <input data-bind="value:model.contractCodeTwo,text:model.contractCodeTwo"
                                       id="contractCodeTwoInput"
                                       style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="contractCodeThreeInput">合同号3</label>
                            <div class="col-xs-8">
                                <input data-bind="value:model.contractCodeThree,text:model.contractCodeThree"
                                       id="contractCodeThreeInput"
                                       style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="orderNumberInput">委托单编号</label>
                            <div class="col-xs-8">
                                <input disabled class="k-textbox" data-bind="value:model.orderNumber"
                                       data-role="maskedtextbox"
                                       id="orderNumberInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="consignorNameInput">货主名称</label>
                            <div class="col-xs-8">
                                <input required class="k-textbox" data-bind="value:model.consignorName"
                                       data-role="maskedtextbox"
                                       id="consignorNameInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="carrierInput">承运方</label>
                            <div class="col-xs-8">
                                <input required data-bind="value:model.carrier,text:model.carrier"
                                       id="carrierInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="drawGoodsDateInput">提货日期</label>
                            <div class="col-xs-8">
                                <input required="" data-bind="value:model.drawGoodsDate"
                                       id="drawGoodsDateInput" style="width: 100%;margin-right:5px;">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="arrivedDateInput">送达日期</label>
                            <div class="col-xs-8">
                                <input required data-bind="value:model.arrivedDate"
                                       id="arrivedDateInput" style="width: 100%;margin-right:5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-3">
                        <div class="form-group" id="drawGoodsUnitDiv">
                            <label class="col-xs-4 control-label" for="drawGoodsUnitInput">提货仓库</label>
                            <div class="col-xs-8">
                                <input required data-bind="value:model.drawGoodsUnit,text:model.drawGoodsUnit"
                                       id="drawGoodsUnitInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="drawGoodsPeopleInput">发货人</label>
                            <div class="col-xs-8">
                                <input required class="k-textbox" data-bind="value:model.drawGoodsPeople"
                                       data-role="maskedtextbox"
                                       id="drawGoodsPeopleInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="drawGoodsMobileInput">发货人联系方式</label>
                            <div class="col-xs-8">
                                <input required class="k-textbox" data-bind="value:model.drawGoodsMobile"
                                       data-role="maskedtextbox"
                                       id="drawGoodsMobileInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-2 control-label" for="drawGoodsAddressDetailInput">提货地址</label>
                            <div class="col-xs-10" id="drawGoodsAddressDetailInput">
                                <input  required data-bind="value:model.drawGoodsProvince"
                                        id="drawGoodsProvinceInput" style="width:32%;margin-right:1%;">

                                <input required data-bind="value:model.drawGoodsCity"
                                       id="drawGoodsCityInput" style="width:32%;margin-right:1%;">

                                <input required data-bind="value:model.drawGoodsArea"
                                       id="drawGoodsAreaInput" style="width:32%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-2 control-label" for="drawGoodsAddressInput">详细地址</label>
                            <div class="col-xs-10">
                                <input  class="k-textbox" required data-bind="value:model.drawGoodsAddress"
                                        data-role="maskedtextbox"
                                        id="drawGoodsAddressInput" style="width:100%;margin-right:5px;"
                                        type="text">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="consigneeUnitInput">收货单位</label>
                            <div class="col-xs-8">
                                <input required data-bind="value:model.consigneeUnit,text:model.consigneeUnit"
                                       id="consigneeUnitInput" style="width: 100%;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="consigneeInput">收货人</label>
                            <div class="col-xs-8">
                                <input required class="k-textbox" data-bind="value:model.consignee"
                                       data-role="maskedtextbox"
                                       id="consigneeInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="consigneeMobileInput">收货人联系电话</label>
                            <div class="col-xs-8">
                                <input required class="k-textbox" data-bind="value:model.consigneeMobile"
                                       data-role="maskedtextbox"
                                       id="consigneeMobileInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-2 control-label" for="consigneeAddressDetailInput">收货地址</label>
                            <div class="col-xs-10" id="consigneeAddressDetailInput">
                                <input required data-bind="value:model.consigneeProvince"
                                       id="consigneeProvinceInput" style="width:32%;margin-right:1%;">

                                <input required data-bind="value:model.consigneeCity"
                                       id="consigneeCityInput" style="width:32%;margin-right:1%;">

                                <input required data-bind="value:model.consigneeArea"
                                       id="consigneeAreaInput" style="width:32%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="col-xs-2 control-label" for="consigneeAddressInput">详细地址</label>
                            <div class="col-xs-10">
                                <input class="k-textbox" required data-bind="value:model.consigneeAddress"
                                       data-role="maskedtextbox"
                                       id="consigneeAddressInput" style="width:100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="statusInput">状态</label>
                            <div class="col-xs-8">
                                <input disabled data-bind="value:model.status"
                                       id="statusInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="rejectReasonInput">拒绝原因</label>
                            <div class="col-xs-8">
                                <input class="k-textbox" disabled data-bind="value:model.rejectReason"
                                       data-role="maskedtextbox"
                                       id="rejectReasonInput" style="width: 100%;margin-right:5px;"
                                       type="text">
                                <!--<textarea disabled name="rejectReason" data-bind="value:model.rejectReason"-->
                                <!--id="rejectReasonInput" style="width:100%;margin-right:5px;">-->
                                <!--</textarea>-->
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="remarkInput">更多描述</label>
                            <div class="col-xs-8">
                                            <textarea name="remark" data-bind="value:model.remark"
                                                      id="remarkInput" style="width: 100%;margin-right:5px;">
                                            </textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-3">
                        <div class="form-group">
                            <label class="col-xs-4 control-label" for="linkInput">链接</label>
                            <div class="col-xs-8">
                                <input class="k-textbox" data-bind="value:model.link"
                                       data-role="maskedtextbox"
                                       id="linkInput" style="width: 100%;margin-right:5px;"
                                       onclick="goTo666()"
                                       type="button">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="tabstrip">
        <ul id="mainUl">
            <!--委托单行-->
            <li id="lineTab">委托单行</li>
            <!--运输单-->
            <li id="transportTab">运输单</li>
        </ul>
        <!-- 委托单行 -->
        <div>
            <div id="order-line">
                <form class="form-horizontal">
                    <div class="panel-body">
                        <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                            <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:create"><@spring.message "hap.new"/></span>
                            <span class="btn btn-success k-grid-save-changes" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                            <span  data-bind="click:remove" class="btn btn-danger" style="float:left;margin-right:5px;"><@spring.message "hap.delete"/></span>
                            <span onclick="submitData()" class="btn btn-default" style="float:left;margin-right:5px;">提交</span>
                            <span class="btn btn-danger" data-bind="click:backFunction" style="float:left;margin-right:5px;"><@spring.message "hap.back"/></span>
                        </div>
                        <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
                        <div style="clear:both">
                            <div id="grid"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!--运输单-->
        <div>
            <div id="transport">
                <form class="form-horizontal">
                    <div class="panel-body">
                        <div class="pull-left" id="toolbar-btn-trans" style="padding-bottom:10px;">
                            <span onclick="syncTransFrom66()" class="btn btn-success k-grid-save-changes" style="float:left;margin-right:5px;">同步运输单</span>
                            <span class="btn btn-danger" data-bind="click:backFunction" style="float:left;margin-right:5px;"><@spring.message "hap.back"/></span>
                        </div>
                        <script>kendo.bind($('#toolbar-btn-trans'), viewModel);</script>
                        <div style="clear:both">
                            <div id="gridTransport"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        var tabToActivate = $("#lineTab");
        $("#tabstrip").kendoTabStrip({
            show: function (e) {
                // 用 currentTab 保存当前tab页的id
                currentTable = e.item.id;
            },
        }).data("kendoTabStrip").activateTab(tabToActivate);

        function goTo666() {
            if (viewModel.model.link) {
                window.open(viewModel.model.link)
            }
        }
    </script>
    <script>
        //提货日期
        kendo.bind($('#edit-form'), viewModel);
        $("#drawGoodsDateInput").kendoDatePicker({
            format: "{0:yyyy-MM-dd}"
        });

        //送达日期
        $("#arrivedDateInput").kendoDateTimePicker({});

        //收货单位
        $("#consigneeUnitInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_CS_CONTRACT_CUSTOM")}, {
                dataTextField: 'customerName',
                dataValueField: 'customerName',
        }));

        //合同1
        $("#contractCodeOneInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_CS_CONTRACT")}, {
            dataTextField: 'custPoNumber',
            dataValueField: 'custPoNumber',
        }));
        //合同2
        $("#contractCodeTwoInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_CS_CONTRACT")}, {
            dataTextField: 'custPoNumber',
            dataValueField: 'custPoNumber',
        }));
        //合同3
        $("#contractCodeThreeInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_CS_CONTRACT")}, {
            dataTextField: 'custPoNumber',
            dataValueField: 'custPoNumber',
        }));

        //承运方
        $("#carrierInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_LM_ORDER_CARRIER")}, {
            dataTextField: 'carrier',
            dataValueField: 'carrier',
        }));

        //提货单位
        $("#drawGoodsUnitInput").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "HCUX_MDM_INVENTORY_ADDRESS")}, {
            dataTextField: 'marehouseName',
            dataValueField: 'marehouseName',
            select: function (e) {
                viewModel.model.set('drawGoodsProvince', e.item.province);
                viewModel.model.set('drawGoodsCity', e.item.city);
                viewModel.model.set('drawGoodsArea', e.item.area);
                viewModel.model.set('drawGoodsAddress', e.item.address);
                specialDeal();
            }
        }));

        //状态
        $('#statusInput').kendoDropDownList({
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: orderStatus
        });
    </script>

    <!--收货地址和提货地址下来框-->
    <script>
        //收货地址
        consigneefirstDropDownList=$('#consigneeProvinceInput').kendoDropDownList({
            optionLabel: '--请选择省份--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData,
            change:function(e){
                consigneeSecondDropDownList.dataSource.filter({ field: "parentCodeValue", operator: "eq", value: parseInt(consigneefirstDropDownList.dataItem().value) });
                consigneeSecondDropDownList.select(-1);
                consigneeThirdDropDownList.select(-1);

                //直辖市
                if (e.sender._old =="110000" || e.sender._old=="120000" || e.sender._old=="310000" || e.sender._old=="500000") {
                    consigneeSecondDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.consigneeProvince });
                }
            }
        }).data("kendoDropDownList");
        consigneefirstDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 1 });
        consigneeSecondDropDownList= $('#consigneeCityInput').kendoDropDownList({
            optionLabel: '--请选择城市--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData,
            change:function(e){
                consigneeThirdDropDownList.dataSource.filter({ field: "parentCodeValue", operator: "eq", value: parseInt(consigneeSecondDropDownList.dataItem().value) });
                //无行政区的地级市
                if (consigneeThirdDropDownList.dataSource._view.length === 0) {
                    consigneeThirdDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.consigneeCity });
                }
                consigneeThirdDropDownList.select(-1);
            }
        }).data("kendoDropDownList");
        consigneeSecondDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 2 });
        consigneeThirdDropDownList=$('#consigneeAreaInput').kendoDropDownList({
            optionLabel: '--请选择地区--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData
        }).data("kendoDropDownList");
        consigneeThirdDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 3 });

        //提货地址
        drawGoodsFirstDropDownList=$('#drawGoodsProvinceInput').kendoDropDownList({
            optionLabel: '--请选择省份--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData,
            change:function(e){
                drawGoodsSecondDropDownList.dataSource.filter({ field: "parentCodeValue", operator: "eq", value: parseInt(drawGoodsFirstDropDownList.dataItem().value) });
                drawGoodsSecondDropDownList.select(-1);
                drawGoodsThirdDropDownList.select(-1);

                //直辖市
                if (e.sender._old =="110000" || e.sender._old=="120000" || e.sender._old=="310000" || e.sender._old=="500000") {
                    drawGoodsSecondDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.drawGoodsProvince });
                }
            }
        }).data("kendoDropDownList");
        drawGoodsFirstDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 1 });
        drawGoodsSecondDropDownList=$('#drawGoodsCityInput').kendoDropDownList({
            optionLabel: '--请选择城市--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData,
            change:function(e){
                drawGoodsThirdDropDownList.dataSource.filter({ field: "parentCodeValue", operator: "eq", value: parseInt(drawGoodsSecondDropDownList.dataItem().value) });
                //无行政区的地级市
                if (drawGoodsThirdDropDownList.dataSource._view.length === 0) {
                    drawGoodsThirdDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.drawGoodsCity });
                }
                drawGoodsThirdDropDownList.select(-1);
            }
        }).data("kendoDropDownList");
        drawGoodsSecondDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 2 });
        drawGoodsThirdDropDownList= $('#drawGoodsAreaInput').kendoDropDownList({
            optionLabel: '--请选择地区--',
            dataTextField: "meaning",
            dataValueField: "value",
            valuePrimitive: true,
            dataSource: addressData
        }).data("kendoDropDownList");
        drawGoodsThirdDropDownList.dataSource.filter({ field: "tag", operator: "eq", value: 3 });

    </script>
</div>
<div id="searchImg"></div>

<script type="text/javascript">
    // Hap.initEnterQuery('#query-form', viewModel.query);
    //验证
    $("#edit-form").kendoValidator({
        invalidMessageType: "tooltip"
    });

    var BaseUrl = _basePath;
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hcux/lm/order/line/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hcux/lm/order/line/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hcux/lm/order/line/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hcux/lm/order/line/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    if(operationType === 'COPY' || operationType === 'COPY_TO_EDIT') {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    } else {
                        return Hap.prepareQueryParameter({orderId: orderId}, options)
                    }
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "orderLineId",
                fields: {
                    goodsNumber:{
                        type:"number",
                        validation: {required: true, min:1}
                    },
                    goodsName:{validation: {required: true}},
                    goodsCode:{validation: {required: true}},
                    unit:{defaultValue: 't',tvalidation: {required: true}},
                    settlementWay:{validation: {required: true}},
                    freightPrice:{validation: {required: true}},
                    dangerGoodsUn:{editable:false},
                    dangerGoodsCat:{editable:false},
                }
            }
        }
    });

    $("#grid").kendoGrid({
        dataSource: dataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "goodsName",
                title: '货物名称',
                width: 120,
                editor: function (container, options) {
                    $('<input id="' + options.field + '" required name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoLov({
                            code: "HCUX_LM_ORDER_ITEM",
                            contextPath: _basePath,
                            locale: _locale,
                            textField: 'goodsName',
                            model: options.model,
                            query:function(e){
                                e.param["contractCodeOne"]=viewModel.model.contractCodeOne;
                                e.param["contractCodeTwo"]=viewModel.model.contractCodeTwo;
                                e.param["contractCodeThree"]=viewModel.model.contractCodeThree;
                            },
                            select: function (e) {
                                options.model.goodsCode = e.item.itemCode;
                                options.model.goodsName = e.item.itemName;
                                $.ajax({
                                    type: 'POST',
                                    url: '${base.contextPath}/hcux/mdm/dangerousgoods/queryEnabled',
                                    datatype: "json",
                                    async: false,
                                    data: {itemNum: e.item.itemCode},
                                    success: function (data) {
                                        if (data.success && data.rows.length > 0) {
                                            options.model.dangerGoodsUn = data.rows[0].dangerGoodsUn
                                            options.model.dangerGoodsCat = data.rows[0].dangerGoodsCat
                                        }
                                    }
                                });
                                $("#grid").data("kendoGrid").refresh();
                            },
                        })
                }
            },
            {
                field: "goodsNumber",
                title: '货物数量',
                width: 120
            },
            {
                field: "unit",
                title: '单位',
                width: 120,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(itemUnit, dataItem.unit) || '';
                },
                editor: function (container, options) {
                    $('<input  name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource: itemUnit
                        });
                }
            },
            {
                field: "settlementWay",
                title: '结算方式',
                width: 120,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(itemSettlementWay, dataItem.settlementWay) || '';
                },
                editor: function (container, options) {
                    $('<input  name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource: itemSettlementWay
                        });
                }
            },
            {
                field: "freightPrice",
                title: '运价',
                width: 120
            },
            {
                field: "remark",
                title: '备注',
                width: 120
            },
            {
                field: "dangerGoodsUn",
                title: 'UN号',
                width: 120,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(dangerGoodsUnData, dataItem.dangerGoodsUn) || '';
                },
            },
            {
                field: "dangerGoodsCat",
                title: '类别及项别',
                width: 120,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(dangerGoodsCatData, dataItem.dangerGoodsCat) || '';
                },
            },
        ],
        editable: true
    });

    if(orderId && orderId > 0) {
        $.ajax({
            type: "POST",
            url: "${base.contextPath}/hcux/lm/order/header/queryOne?orderId=" + orderId,
            dataType: "json",
            contentType: 'application/json',
            async: false,
            error: function () {
                kendo.ui.showErrorDialog({
                    message: '<@spring.message "hap.error"/>'
                });
            },
            success: function (data) {
                $.each(data.rows[0], function (k, v) {
                    if (!$.isEmpty(v)) {
                        viewModel.model.set(k, v);
                        if (k === 'status' && v === '1' && operationType === 'EDIT') {
                            disabledAll();
                        }
                    }
                });

                if (operationType === 'EDIT') {
                    $('#contractCodeOneInput').data("kendoLov").enable(false);
                    $('#contractCodeTwoInput').data("kendoLov").enable(false);
                    $('#contractCodeThreeInput').data("kendoLov").enable(false);
                }

                if (operationType === 'COPY') {
                    viewModel.model.set('orderId', null);
                    viewModel.model.set('zhOrderId', null);
                    viewModel.model.set('zhOrderNumber', null);
                    viewModel.model.set('contractCodeOne', null);
                    viewModel.model.set('contractCodeTwo', null);
                    viewModel.model.set('contractCodeThree', null);
                    viewModel.model.set('orderNumber', null);
                    viewModel.model.set('drawGoodsDate', defaultDrawGoodsDate);
                    viewModel.model.set('arrivedDate', defaultArrivedDate);
                    viewModel.model.set('rejectReason', null);
                    viewModel.model.set('link', null);
                }
                specialDeal();
            },
        });
    }

    function disabledAll() {
        $("#edit-form input").addClass('k-state-disabled');
        $("#edit-form input").attr("readonly", true);

        $(".k-state-required").removeClass("k-state-required");

        $("#remarkInput").addClass('k-state-disabled');
        $("#remarkInput").attr("readonly", true);

        $("#edit-form input").css('color','#000');
        $("#remarkInput").css('color','#000');

        $("#drawGoodsDateInput").data("kendoDatePicker").enable(false);
        $("#arrivedDateInput").data("kendoDateTimePicker").enable(false);
        $("#consigneeUnitInput").data("kendoLov").enable(false);
        $('#contractCodeOneInput').data("kendoLov").enable(false);
        $('#contractCodeTwoInput').data("kendoLov").enable(false);
        $('#contractCodeThreeInput').data("kendoLov").enable(false);
        $('#carrierInput').data("kendoLov").enable(false);
        $('#drawGoodsUnitInput').data("kendoLov").enable(false);


        $('#consigneeProvinceInput').data("kendoDropDownList").enable(false);
        $('#consigneeCityInput').data("kendoDropDownList").enable(false);
        $('#consigneeAreaInput').data("kendoDropDownList").enable(false);
        $('#drawGoodsProvinceInput').data("kendoDropDownList").enable(false);
        $('#drawGoodsCityInput').data("kendoDropDownList").enable(false);
        $('#drawGoodsAreaInput').data("kendoDropDownList").enable(false);

        $('#toolbar-btn').hide();
        $("#grid").data("kendoGrid").setOptions({editable: false});
    }

    function specialDeal() {
        //提货地址市或区输入框为空
        if (!$('#consigneeCityInput').val()) {
            consigneeSecondDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.consigneeCity });
            consigneeSecondDropDownList.select(1);
        }
        if (!$('#consigneeAreaInput').val()) {
            consigneeThirdDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.consigneeArea });
            consigneeThirdDropDownList.select(1);
        }

        //收货地址市或区输入框为空
        if (!$('#drawGoodsCityInput').val()) {
            drawGoodsSecondDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.drawGoodsCity });
            drawGoodsSecondDropDownList.select(1);
        }
        if (!$('#drawGoodsAreaInput').val()) {
            drawGoodsThirdDropDownList.dataSource.filter({ field: "value", operator: "eq", value: viewModel.model.drawGoodsArea });
            drawGoodsThirdDropDownList.select(1);
        }
    }
</script>

<script type="text/javascript">
    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;
    dataSourceTransport = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hcux/lm/transport/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hcux/lm/transport/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hcux/lm/transport/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hcux/lm/transport/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    if(operationType === 'COPY' || operationType === 'COPY_TO_EDIT') {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    } else {
                        return Hap.prepareQueryParameter({orderId: orderId}, options)
                    }
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "transportId",
                fields: {}
            }
        }
    });

    $("#gridTransport").kendoGrid({
        dataSource:  dataSourceTransport,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "transportCode",
                title: '运输单号',
                width: 160
            },
            {
                field: "transportStatus",
                title: '运输单状态',
                width: 120,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(transportStatusData, dataItem.transportStatus) || '';
                }
            },
            {
                field: "attachmentId",
                title: '运输回执单',
                width: 120,
                template: function (rowdata) {
                    return '<a style="text-decoration : none;color : blue;cursor:pointer" onclick="searchImg(' + rowdata.transportId + ')">'
                        + '查看('+ rowdata.imgCount +')'
                        + '</a>'
                }
            },
            {
                field: "driverName",
                title: '司机名称',
                width: 120
            },
            {
                field: "driverMobile",
                title: '司机电话',
                width: 120
            },
            {
                field: "driverId",
                title: '司机身份证号',
                width: 120
            },
            {
                field: "carNumber",
                title: '车牌号',
                width: 120
            },
            {
                field: "trailerCarNumber",
                title: '挂车车牌号',
                width: 120
            },
            {
                field: "remark",
                title: '运输单备注',
                width: 120
            },
            {
                field: "goodsName",
                title: '货物名称',
                width: 120
            },
            {
                field: "dispatchAmount",
                title: '调度数量',
                width: 120
            },
            {
                field: "unit",
                title: '单位',
                width: 120
            },
            {
                field: "drawGoodsAmount",
                title: '提货数量',
                width: 120
            },
            {
                field: "drawGoodsDate",
                title: '提货时间',
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "signAmount",
                title: '签收数量',
                width: 120
            },
            {
                field: "signDate",
                title: '签收时间',
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "settlementWay",
                title: '结算模式',
                width: 120
            },
            {
                field: "transportPrice",
                title: '运价',
                width: 120
            },
            {
                field: "link",
                title: '运输单链接',
                width: 120,
                template: function (rowdata) {
                    if (rowdata.link) {
                        return '<a href="'+ rowdata.link +'" target="_blank" style="text-decoration : none;color : blue;cursor:pointer">'
                            + rowdata.link
                            + '</a>'
                    } else {
                        return '';
                    }
                }
            },
        ],
        editable: false
    });

    function searchImg(transportId) {
        var url = '${base.contextPath}/lm/lm_transport_img.html?transportId=' + transportId;
        var dialog = $("#searchImg").kendoWindow({
            actions: ["Close"],
            title: '运输回执单',
            content: url,
            iframe: true,
            visible: false,
            resizable: false,
            modal: true,
            width: 900,
            height: 450,
            close: function () {
                $('#gridTransport').data('kendoGrid').dataSource.page(1);
            }
        }).data("kendoWindow");
        dialog.center().open();
    }
</script>
</body>
</html>